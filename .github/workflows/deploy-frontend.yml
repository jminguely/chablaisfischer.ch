name: Deploy Nuxt Frontend to Alwaysdata

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/deploy-frontend.yml
      - frontend/**

jobs:
  ci:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: frontend

    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [18]

    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup node env 🏗
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          check-latest: true
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies 👨🏻‍💻
        run: npm install

      - name: Run build 👷🏻
        run: npm run build
        env:
          WP_GRAPHQL_ENDPOINT: ${{ vars.GRAPHQL_API_URL }}

      - name: Install SSH Host Key
        id: deploy
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_KEY }}
          name: github-actions
          known_hosts: ${{ vars.SSH_HOST_KEY }}
          config: |
            host ${{ vars.SSH_HOST }}
            IdentityFile ~/.ssh/github-actions
            IdentitiesOnly yes
            ForwardAgent yes

      - name: Adds SSH Agent
        run: |
          eval "$(ssh-agent -s)"
          ssh-add -D
          ssh-add ~/.ssh/github-actions

      - name: Set SSH Key Permissions
        run: chmod 600 ~/.ssh/github-actions

      - name: Sync .ouput files to server
        run: rsync -auvzrl --delete --ignore-missing-args -e "ssh -o BatchMode=yes -o StrictHostKeyChecking=no" ./.output/ ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:${{ vars.DEPLOY_PATH }}/frontend
        env:
          RSYNC_RSH: "ssh -o BatchMode=yes -o StrictHostKeyChecking=no"

      - name: 🧨 Kickstart node server
        run: curl --basic --user '${{ secrets.ALWAYSDATA_API }} account=eikon:' --data '' --request POST https://api.alwaysdata.com/v1/site/${{ vars.ALWAYSDATA_SITE_ID }}/restart/
